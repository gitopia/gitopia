version: "4"

services:
  gitopiad:
    image: gitopia/gitopiad-e2e
    build:
      context: ../../
      dockerfile: Dockerfile
    volumes:
      - ./scripts/setup_chain.sh:/gitopia/setup.sh
      - $HOME/.gitopia-local/:/gitopia/.gitopia/
      - gitopiad-binary:/gitopia/bin  # New volume to share the binary
    entrypoint:
      - /gitopia/setup.sh
    environment:
      - HOME=/gitopia
      - CHAIN_ID=localgitopia
    ports:
      - 1317:1317
      - 9090:9090
      - 26657:26657
    expose:
      - 9090
      - 26657
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:26657/status"]
      interval: 10s
      timeout: 5s
      retries: 5

  git-server:
    image: gitopia/git-server
    ports:
      - 5001:5000
    volumes:
      - /var/repos:/var/repos

  faucet:
    image: gitopia/faucet
    ports:
      - 8000:8000
    volumes:
      - gitopiad-binary:/usr/local/gitopia/bin:ro  # Share the binary with the faucet
    environment:
      - PATH=/usr/local/gitopia/bin:$PATH
      - CLI_NAME=gitopiad
      - NODE=http://gitopiad:26657
      - KEYRING_BACKEND=test
      - ACCOUNT_NAME=feegrant
      - MNEMONIC="kangaroo custom casino hawk ship fine meadow noble holiday elite kitchen idea spoon pencil dilemma image endorse apple monkey predict satisfy layer rail version"
      - DENOMS=ulore
      - CREDIT_AMOUNT=1000000000000
      - MAX_CREDIT=1000000000000
      - FEES=200ulore
    depends_on:
      gitopiad:
        condition: service_healthy

volumes:
  gitopiad-binary:
