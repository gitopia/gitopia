version: "4"

services:
  gitopiad:
    image: gitopia/gitopiad-e2e
    build:
      context: ../../
      dockerfile: Dockerfile
    volumes:
      - ./scripts/setup_chain.sh:/gitopia/setup.sh
      - $HOME/.gitopia-local/:/gitopia/.gitopia/
      - gitopiad-binary:/gitopia/bin  # New volume to share the binary
    entrypoint:
      - /gitopia/setup.sh
    environment:
      - HOME=/gitopia
      - CHAIN_ID=localgitopia
    ports:
      - 1317:1317
      - 9090:9090
      - 26657:26657
    expose:
      - 9090
      - 26657
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:26657/status"]
      interval: 10s
      timeout: 5s
      retries: 5

  git-server:
    image: gitopia/git-server
    ports:
      - 5001:5000
    volumes:
      - /var/repos:/var/repos

  faucet:
    image: gitopia/faucet
    ports:
      - 4500:4500
    volumes:
      - gitopiad-binary:/usr/local/gitopia/bin:ro  # Share the binary with the faucet
    environment:
      - PATH=/usr/local/gitopia/bin:$PATH
    depends_on:
      gitopiad:
        condition: service_healthy

volumes:
  gitopiad-binary:
